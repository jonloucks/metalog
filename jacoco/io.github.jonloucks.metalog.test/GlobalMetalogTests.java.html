<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GlobalMetalogTests.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">metalog</a> &gt; <a href="index.source.html" class="el_package">io.github.jonloucks.metalog.test</a> &gt; <span class="el_source">GlobalMetalogTests.java</span></div><h1>GlobalMetalogTests.java</h1><pre class="source lang-java linenums">package io.github.jonloucks.metalog.test;

import io.github.jonloucks.contracts.api.*;
import io.github.jonloucks.metalog.api.*;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.junit.jupiter.params.ParameterizedTest;
import org.junit.jupiter.params.provider.Arguments;
import org.junit.jupiter.params.provider.MethodSource;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.mockito.junit.jupiter.MockitoSettings;
import org.mockito.quality.Strictness;

import java.time.Duration;
import java.util.stream.Stream;

import static io.github.jonloucks.contracts.test.Tools.*;
import static io.github.jonloucks.metalog.test.Tools.metaWithId;
import static io.github.jonloucks.metalog.test.Tools.uniqueString;
import static java.util.Optional.ofNullable;
import static org.junit.jupiter.api.Assertions.*;
import static org.junit.jupiter.api.Assumptions.assumeTrue;
import static org.mockito.Mockito.*;

@SuppressWarnings(&quot;CodeBlock2Expr&quot;)
@ExtendWith(MockitoExtension.class)
@MockitoSettings(strictness = Strictness.LENIENT)
public interface GlobalMetalogTests {
    
    @Test
    default void globalMetalog_Instantiate_Throws() {
<span class="fc" id="L33">        assertInstantiateThrows(GlobalMetalog.class);</span>
<span class="fc" id="L34">    }</span>
    
    @Test
    default void globalMetalog_getInstance_Works() {
<span class="fc" id="L38">        assertObject(GlobalMetalog.getInstance());</span>
<span class="fc" id="L39">    }</span>
 
    @Test
    default void globalMetalog_LogWithBuild_RoundTrip(@Mock Subscriber subscriber, @Mock Log log) {
<span class="fc" id="L43">        final String text = uniqueString();</span>
<span class="fc" id="L44">        when(log.get()).thenReturn(text);</span>
<span class="fc" id="L45">        when(subscriber.test(any())).thenReturn(true);</span>
<span class="fc" id="L46">        final String id = uniqueString();</span>
        
<span class="fc" id="L48">        try (AutoClose closeSubscriber = GlobalMetalog.subscribe(subscriber)) {</span>
<span class="fc" id="L49">            final AutoClose ignored = closeSubscriber;</span>
<span class="fc" id="L50">            GlobalMetalog.publish(log, b -&gt; b.id(id).block());</span>
<span class="fc" id="L51">            verify(subscriber, times(1)).receive(any(), metaWithId(id));</span>
        }
<span class="fc" id="L53">        GlobalMetalog.publish(log, b -&gt; b.id(id).block());</span>
<span class="fc" id="L54">        verify(subscriber, times(1)).receive(any(), metaWithId(id));</span>
<span class="fc" id="L55">    }</span>
    
    @Test
    default void globalMetalog_Log_DoesNotThrow() {
<span class="pc" id="L59">        assertDoesNotThrow(() -&gt; GlobalMetalog.publish((() -&gt; &quot;hi&quot;)));</span>
<span class="fc" id="L60">    }</span>
    
    @Test
    default void globalMetalog_LogAndMeta_DoesNotThrow() {
<span class="pc" id="L64">        assertDoesNotThrow(() -&gt; GlobalMetalog.publish((() -&gt; &quot;hi&quot;), Meta.DEFAULT));</span>
<span class="fc" id="L65">    }</span>
    
    @Test
    default void globalMetalog_LogAndBuilder_DoesNotThrow() {
<span class="pc" id="L69">        assertDoesNotThrow(() -&gt; GlobalMetalog.publish((() -&gt; &quot;hi&quot;), b -&gt; b.name(&quot;x&quot;)));</span>
<span class="fc" id="L70">    }</span>
    
    @Test
    default void globalMetalog_DefaultConfig() {
<span class="fc" id="L74">        final Metalog.Config config = new Metalog.Config() {};</span>
        
<span class="fc" id="L76">        assertAll(</span>
<span class="fc" id="L77">            () -&gt; assertTrue(config.useReflection(), &quot;config.useReflection() default.&quot;),</span>
<span class="fc" id="L78">            () -&gt; assertTrue(config.useServiceLoader(), &quot;config.useServiceLoader() default.&quot;),</span>
<span class="fc" id="L79">            () -&gt; assertNotNull(config.reflectionClassName(), &quot;config.reflectionClassName() was null.&quot;),</span>
<span class="fc" id="L80">            () -&gt; assertEquals(MetalogFactory.class, config.serviceLoaderClass(), &quot;config.serviceLoaderClass() default.&quot;),</span>
<span class="fc" id="L81">            () -&gt; assertEquals(GlobalContracts.getInstance(), config.contracts(), &quot;config.contracts()  default.&quot;),</span>
<span class="fc" id="L82">            () -&gt; assertEquals(1_000, config.keyedQueueLimit(), &quot;config.keyedQueueLimit() default.&quot;),</span>
<span class="fc" id="L83">            () -&gt; assertEquals(10, config.unkeyedThreadCount(), &quot;config.unkeyedThreadCount() default.&quot;),</span>
<span class="fc" id="L84">            () -&gt; assertFalse(config.unkeyedFairness(), &quot;config.unkeyedFairness() default.&quot;),</span>
<span class="fc" id="L85">            () -&gt; assertEquals(Duration.ofSeconds(60), config.shutdownTimeout(), &quot;config.shutdownTimeout() default.&quot;),</span>
<span class="fc" id="L86">            () -&gt; assertTrue(config.systemOutput(), &quot;config.systemOutput() default.&quot;)</span>
        );
<span class="fc" id="L88">    }</span>
    
    @ParameterizedTest
    @MethodSource(&quot;io.github.jonloucks.metalog.test.GlobalMetalogTests$GlobalMetalogTestsTools#validConfigs&quot;)
    default void globalMetalog_HappyPath(Metalog.Config metalogConfig) {
<span class="fc" id="L93">        final Metalog metalog = GlobalMetalog.createMetalog(metalogConfig);</span>
        
<span class="fc" id="L95">        assumeTrue(ofNullable(metalog).isPresent(), &quot;createContracts failed&quot;);</span>
        
<span class="fc" id="L97">        try (AutoClose closeMetalog = metalog.open()) {</span>
<span class="fc" id="L98">            final AutoClose ignored = closeMetalog;</span>
            
<span class="fc" id="L100">            final Contracts contracts = metalogConfig.contracts();</span>
            
<span class="fc" id="L102">            assertTrue(contracts.isBound(Metalog.CONTRACT));</span>
<span class="fc" id="L103">            assertTrue(contracts.isBound(MetalogFactory.CONTRACT));</span>
<span class="fc" id="L104">            assertTrue(contracts.isBound(Entities.Builder.FACTORY_CONTRACT));</span>
<span class="fc" id="L105">            assertTrue(contracts.isBound(Entity.Builder.FACTORY_CONTRACT));</span>
<span class="fc" id="L106">            assertTrue(contracts.isBound(Meta.Builder.FACTORY_CONTRACT));</span>
            
<span class="pc bpc" id="L108" title="1 of 2 branches missed.">            if (metalogConfig.systemOutput()) {</span>
<span class="fc" id="L109">                assertTrue(contracts.isBound(Console.CONTRACT));</span>
            }
        }
<span class="fc" id="L112">    }</span>
    
    @ParameterizedTest
    @MethodSource(&quot;io.github.jonloucks.metalog.test.GlobalMetalogTests$GlobalMetalogTestsTools#invalidConfigs&quot;)
    default void globalMetalog_SadPath(Metalog.Config metalogConfig) {
<span class="fc" id="L117">        final ContractException thrown = assertThrows(ContractException.class, () -&gt; {</span>
<span class="nc" id="L118">            GlobalMetalog.createMetalog(metalogConfig);</span>
<span class="nc" id="L119">        });</span>
        
<span class="fc" id="L121">        assertThrown(thrown);</span>
<span class="fc" id="L122">    }</span>
    
    @Test
    default void globalMetalog_InternalCoverage() {
<span class="fc" id="L126">        assertInstantiateThrows(GlobalMetalogTests.GlobalMetalogTestsTools.class);</span>
<span class="fc" id="L127">    }</span>
    
    final class GlobalMetalogTestsTools {
<span class="nc" id="L130">        private GlobalMetalogTestsTools() {</span>
<span class="nc" id="L131">            throw new AssertionError(&quot;Illegal constructor&quot;);</span>
        }
        @SuppressWarnings(&quot;RedundantMethodOverride&quot;)
        static Stream&lt;Arguments&gt; validConfigs() {
<span class="fc" id="L135">            return Stream.of(</span>
<span class="fc" id="L136">                Arguments.of(new Metalog.Config() {}),</span>
<span class="fc" id="L137">                Arguments.of(new Metalog.Config() {</span>
                    @Override
                    public boolean useServiceLoader() {
<span class="nc" id="L140">                        return false;</span>
                    }
                    @Override
                    public boolean useReflection() {
<span class="fc" id="L144">                        return true;</span>
                    }
                }),
<span class="fc" id="L147">                Arguments.of(new Metalog.Config() {</span>
                    @Override
                    public boolean useServiceLoader() {
<span class="fc" id="L150">                        return true;</span>
                    }
                    @Override
                    public boolean useReflection() {
<span class="fc" id="L154">                        return false;</span>
                    }
                })
            );
        }
        
        @SuppressWarnings(&quot;RedundantMethodOverride&quot;)
        static Stream&lt;Arguments&gt; invalidConfigs() {
<span class="fc" id="L162">            return Stream.of(</span>
<span class="fc" id="L163">                Arguments.of(new Metalog.Config() {</span>
                    @Override
                    public boolean useServiceLoader() {
<span class="fc" id="L166">                        return false;</span>
                    }
                    @Override
                    public boolean useReflection() {
<span class="fc" id="L170">                        return false;</span>
                    }
                }),
<span class="fc" id="L173">                Arguments.of(new Metalog.Config() {</span>
                    @Override
                    public boolean useServiceLoader() {
<span class="fc" id="L176">                        return true;</span>
                    }
                    @Override
                    public boolean useReflection() {
<span class="fc" id="L180">                        return false;</span>
                    }
                    @Override
                    public Class&lt;? extends MetalogFactory&gt; serviceLoaderClass() {
<span class="fc" id="L184">                        return BadMetalogFactory.class;</span>
                    }
                }),
<span class="fc" id="L187">                Arguments.of(new Metalog.Config() {</span>
                    @Override
                    public boolean useServiceLoader() {
<span class="fc" id="L190">                        return false;</span>
                    }
                    @Override
                    public boolean useReflection() {
<span class="fc" id="L194">                        return true;</span>
                    }
                    @Override
                    public String reflectionClassName() {
<span class="fc" id="L198">                        return BadMetalogFactory.class.getName();</span>
                    }
                }),
<span class="fc" id="L201">                Arguments.of(new Metalog.Config() {</span>
                    @Override
                    public boolean useServiceLoader() {
<span class="fc" id="L204">                        return false;</span>
                    }
                    @Override
                    public boolean useReflection() {
<span class="fc" id="L208">                        return true;</span>
                    }
                    @Override
                    public String reflectionClassName() {
<span class="fc" id="L212">                        return &quot;&quot;;</span>
                    }
                })
            );
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>